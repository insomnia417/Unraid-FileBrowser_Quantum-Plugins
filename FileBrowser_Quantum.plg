<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
  <!ENTITY branch "test">
  <!ENTITY version "2026.01.01">
  <!ENTITY bundleversion "2026.01.01">
  <!ENTITY author "insomnia417">
  <!ENTITY name "filebrowser_quantum">
  <!ENTITY launch "Settings/filebrowser_quantum">
  <!ENTITY description "FileBrowser Quantum for unRAID">
  <!ENTITY support "https://forums.unraid.net/topic/196447-filebrowser-quantum-plugin">
  <!ENTITY pluginURL "https://raw.githubusercontent.com/insomnia417/Unraid-FileBrowser_Quantum-Plugins/&branch;/FileBrowser_Quantum.plg">
  <!ENTITY bundleURL "https://raw.githubusercontent.com/insomnia417/Unraid-FileBrowser_Quantum-Plugins/refs/heads/&branch;/archive/filebrowser_quantum-&bundleversion;-x86_64.txz">
]>
<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" support="&support;">

<CHANGES>
### &name;
#### ğŸ†• æœ€æ–°æ›´æ–° (v&version;)
- **é€»è¾‘ä¼˜åŒ–**ï¼šå¯åœé€»è¾‘æ›´é¡ºç•…,ä¸å†å¼¹çª—.

#### ğŸ“œ å†å²æ”¹è¿›
- **é€»è¾‘ä¼˜åŒ–**ï¼šUIç•Œé¢ç¾åŒ–è°ƒæ•´ï¼Œä¿®å¤ç«¯å£é¢œè‰²ä¸å˜çš„é—®é¢˜ï¼Œæ›´æ˜“ç”¨ã€‚
- **å®‰å…¨åŠ å›º**ï¼šæ–°å¢äºŒè¿›åˆ¶æ–‡ä»¶ SHA256 å®Œæ•´æ€§æ ¡éªŒï¼Œç¡®ä¿ä¸‹è½½å®‰å…¨ã€‚
- **é€»è¾‘ä¼˜åŒ–**ï¼šå®Œå–„ AJAX åˆ†æ”¯åˆ‡æ¢é€»è¾‘ï¼Œå®ç°ç‰ˆæœ¬å·ä¸ UI æŒ‰é’®çš„å®æ—¶è”åŠ¨ã€‚
- **å†…æ ¸å‡çº§**ï¼šå¼•å…¥æ¶æ„è‡ªé€‚åº”é€»è¾‘ï¼Œä¸ºè·¨å¹³å°è¿è¡Œå¥ å®šåŸºç¡€ã€‚
- **æ™ºèƒ½å®‰è£…**ï¼šæ”¯æŒæœ¬åœ°ç¼“å­˜æ ¡éªŒä¸è‡ªåŠ¨æ¸…ç†ï¼Œå¤§å¹…æå‡ç¦»çº¿å®‰è£…/é‡å¯é€Ÿåº¦ã€‚
- **äº¤äº’é‡æ„**ï¼šè®¾ç½®ç•Œé¢æ”¹ä¸ºä¸‰åˆ—å¸ƒå±€ï¼Œå®ç° `config.yaml` å…¨å¯è§†åŒ– UI ç®¡ç†ã€‚
- **åŠ¨æ€é€‚é…**ï¼šç«¯å£æ›´æ”¹è‡ªåŠ¨åŒæ­¥ï¼Œæ–°å¢æœåŠ¡å¯åœå¼€å…³ï¼Œç«¯å£æ˜¾ç¤ºï¼ŒBeta/Stable åˆ†æ”¯åˆ‡æ¢ã€‚
- **è¿ç»´å¢å¼º**ï¼šæ–°å¢åŸºäº PHP çš„å®æ—¶æ—¥å¿—æµç›‘æ§åŠä¸€é”®æ¸…ç©ºæ—¥å¿—åŠŸèƒ½ã€‚

#### ğŸš€ è®¡åˆ’ä¸­ (TO DO)
- **å®‰å…¨è¿æ¥**ï¼šæ¨è¿› iframe æ¡†æ¶ä¸‹çš„ HTTPS åè®®é€‚é…ã€‚
- **å¤šç«¯ä¼˜åŒ–**ï¼šæŒç»­æ”¹è¿›ç§»åŠ¨ç«¯ UI çš„æ“ä½œé¡ºæ»‘åº¦ã€‚
</CHANGES>

  <FILE Name="/boot/config/plugins/filebrowser_quantum/install/filebrowser_quantum-&bundleversion;-x86_64.txz" Run="upgradepkg --install-new">
    <URL>&bundleURL;</URL>
  </FILE>

  <FILE Run="/bin/bash" Method="install">
    <INLINE>
        BUNDLE_V="&bundleversion;"
        PLUGIN_V="&version;"
        NAME="&name;"
        BRANCH="&branch;"
        AUTHOR="&author;"
        <![CDATA[
        GITHUB_REPO="gtsteffaniak/filebrowser"
        INSTALL_PATH="/boot/config/plugins/${NAME}/install"
        mkdir -p "$INSTALL_PATH"

        # 1. å¯»æ‰¾æœ¬åœ°ç¼“å­˜
        LOCAL_BINARY=$(ls -t $INSTALL_PATH/${NAME}-v* 2>/dev/null | head -n 1)

        if [ -f "$LOCAL_BINARY" ]; then
            echo "æ£€æµ‹åˆ°æœ¬åœ°ä¸»ç¨‹åºç¼“å­˜: $(basename $LOCAL_BINARY)ï¼Œè·³è¿‡è”ç½‘æ£€æµ‹ã€‚"
            cp "$LOCAL_BINARY" /usr/sbin/filebrowser_quantumorig.new
            mv /usr/sbin/filebrowser_quantumorig.new /usr/sbin/filebrowser_quantumorig
            current_version=$(basename "$LOCAL_BINARY" | cut -d'-' -f3-)
            INSTALLED_BINARY="$LOCAL_BINARY"
        else
            echo "æœ¬åœ°æ— ç¼“å­˜ï¼Œæ­£åœ¨è”ç½‘æŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬..."
            TAG_LIST=$(curl -s --connect-timeout 5 "https://api.github.com/repos/$GITHUB_REPO/tags" | grep '"name":' | head -n 10)
            
            if [ -z "$TAG_LIST" ]; then
                echo "è­¦å‘Šï¼šæ— æ³•è¿æ¥ GitHub APIï¼Œå°†ä½¿ç”¨ä¿åº•ç‰ˆæœ¬å·..."
                current_version="v1.1.0-stable"
            else
                if [ -f $INSTALL_PATH/beta ]; then
                    current_version=$(echo "$TAG_LIST" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+-beta' | head -n 1)
                    echo "Beta mode detected. Target version: $current_version"
                    [ -z "$current_version" ] && current_version="v1.1.6-beta"
                else
                    current_version=$(echo "$TAG_LIST" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+-stable' | head -n 1)
                    echo "æ£€æµ‹åˆ°æœ€æ–°ç¨³å®šç‰ˆå·ä¸º: $current_version"
                    [ -z "$current_version" ] && current_version="v1.1.0-stable"
                fi
            fi

            INSTALLED_BINARY="$INSTALL_PATH/${NAME}-$current_version"
            filebrowser_quantumurl="https://github.com/$GITHUB_REPO/releases/download/$current_version/linux-amd64-filebrowser"

            echo "å¼€å§‹ä¸‹è½½å¹¶å®‰è£…: $current_version ..."
            curl --connect-timeout 15 --retry 3 -L -o "$INSTALLED_BINARY" --create-dirs "$filebrowser_quantumurl"

            if [ -f "$INSTALLED_BINARY" ]; then
                cp "$INSTALLED_BINARY" /usr/sbin/filebrowser_quantumorig.new
                mv /usr/sbin/filebrowser_quantumorig.new /usr/sbin/filebrowser_quantumorig
            else
                echo "é”™è¯¯ï¼šä¸‹è½½å¤±è´¥ä¸”æœ¬åœ°æ— ç¼“å­˜ï¼"
                exit 1
            fi
        fi

        # --- [2. æ ¸å¿ƒæ ¡éªŒï¼šå¦‚æœåˆ°è¿™æ­¥è¿˜æ²¡æ–‡ä»¶ï¼Œæ‰æŠ¥é”™é€€å‡º] ---
        if [ ! -f /usr/sbin/filebrowser_quantumorig ]; then
            echo "å®‰è£…å¤±è´¥ï¼šæ— æ³•è·å–äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆè”ç½‘å¤±è´¥ä¸”æ— æœ¬åœ°ç¼“å­˜ï¼‰"
            removepkg ${NAME}-${BUNDLE_V}-x86_64 >/dev/null
            exit 1
        fi

        # --- [3. åå‹¤å¤„ç†ï¼šèµ‹æƒã€é…ç½®ã€æ¸…ç†] ---
        chown root:root /usr/sbin/filebrowser_quantumorig
        chmod 755 /usr/sbin/filebrowser_quantumorig
        chown -R root:root /usr/local/emhttp/plugins/${NAME}
        chmod +x /usr/local/emhttp/plugins/${NAME}/*.sh
        chmod 644 /usr/local/emhttp/plugins/${NAME}/*.php

        # ä¸‹è½½é»˜è®¤ config.yaml (å¦‚æœç¼ºå¤±)
        if [ ! -f "/boot/config/plugins/${NAME}/config.yaml" ]; then
            echo "æ­£åœ¨ä¸‹è½½é»˜è®¤é…ç½®..."
            if ! curl -fsSL --connect-timeout 10 --retry 3 -o "/boot/config/plugins/${NAME}/config.yaml" "https://raw.githubusercontent.com/insomnia417/Unraid-FileBrowser_Quantum-Plugins/${BRANCH}/config.yaml"; then
                echo "ä¸‹è½½å¤±è´¥ï¼Œæ­£åœ¨ç”Ÿæˆæœ¬åœ°é»˜è®¤é…ç½®..."
### ----------ä¿åº• config.yaml
cat <<EOF > "/boot/config/plugins/${NAME}/config.yaml"
server:
  port: 8081
  baseURL: "/"
  internalUrl: ""
  database: "/boot/config/plugins/filebrowser_quantum/database.db"
  logging:
    - levels: "info|debug|warning|error"
      output: "/var/log/filebrowser_quantum.log"
  sources:
    - path: "/"
      name: "Root Dir"
EOF
            fi
        fi

        # settings.cfg
        if [ ! -f /boot/config/plugins/${NAME}/settings.cfg ]; then
            echo "é¦–æ¬¡å®‰è£…ï¼Œåˆå§‹åŒ–é»˜è®¤å¼€å¯é…ç½®ã€‚"
            echo "filebrowser_ENABLED=true" > /boot/config/plugins/${NAME}/settings.cfg
        else
            echo "æ£€æµ‹åˆ°å·²æœ‰é…ç½®æ–‡ä»¶ï¼Œæ­£åœ¨ä¿æŒåŸæœ‰è®¾ç½®..."
        fi

        # æ™ºèƒ½æ¸…ç†ï¼šä¿ç•™å½“å‰ txz å’Œå½“å‰ binary
        echo "æ­£åœ¨æ¸…ç†æ—§çš„å®‰è£…æ–‡ä»¶..."
        find "$INSTALL_PATH" -name "${NAME}-*.txz" ! -name "${NAME}-${BUNDLE_V}-x86_64.txz" -delete
        if [ -n "$INSTALLED_BINARY" ]; then
            find "$INSTALL_PATH" -name "${NAME}-v*" ! -name "$(basename "$INSTALLED_BINARY")" -delete
        fi

        # --- [3. æ ¸å¿ƒï¼šæ ¹æ®é…ç½®çŠ¶æ€å†³å®šæ˜¯å¦æ‹‰èµ·æœåŠ¡] ---
        # ä½¿ç”¨ grep æå–å½“å‰çš„ä½¿èƒ½çŠ¶æ€ (true/false)
        ENABLE_STATE=$(grep -oP 'filebrowser_ENABLED=\K\w+' /boot/config/plugins/${NAME}/settings.cfg)

        if [ "$ENABLE_STATE" == "true" ]; then
            echo "é…ç½®çŠ¶æ€ä¸º [å¯ç”¨]ï¼Œæ­£åœ¨å¯åŠ¨ FileBrowser å®ˆæŠ¤è¿›ç¨‹..."
            # ä½¿ç”¨ v2.0.6 Daemon.sh çš„ START_ONLY å‚æ•°ï¼šé™é»˜å¯åŠ¨è¿›ç¨‹ï¼Œä¸å†™ç£ç›˜
            /usr/local/emhttp/plugins/${NAME}/Daemon.sh "START_ONLY"
            echo "â— Filebrowser_Quantum å·²åœ¨åå°å¯åŠ¨"
        else
            echo "é…ç½®çŠ¶æ€ä¸º [ç¦ç”¨]ï¼Œè·³è¿‡è‡ªåŠ¨å¯åŠ¨ã€‚"
        fi

        # åˆ·æ–°è¿œç¨‹ç‰ˆæœ¬å·ç¼“å­˜
        /usr/local/emhttp/plugins/${NAME}/Daemon.sh "VERSION"

        echo ""
        echo "${NAME} ${PLUGIN_V} å®‰è£…æˆåŠŸï¼"
        echo "-----------------------------------------------------------"
        echo ""
        ]]>
    </INLINE>
  </FILE>

  <FILE Run="/bin/bash">
    <INLINE>
        if ! [ -f /bin/fusermount ]; then
        if [ -f /usr/bin/fusermount3 ]; then
            ln -s /usr/bin/fusermount3 /bin/fusermount
        fi;
        fi;
    </INLINE>
  </FILE>

  <FILE Name="/usr/sbin/filebrowser_quantum" Mode="0755">
    <INLINE>
        #!/bin/bash
        config=/boot/config/plugins/filebrowser_quantum/config.yaml
        filebrowser_quantumorig -c $config "$@";
    </INLINE>
  </FILE>

  <FILE Name="/boot/config/plugins/filebrowser_quantum/.gitignore" Mode="0600">
    <INLINE>
        config.yaml
    </INLINE>
  </FILE>

  <FILE Run="/bin/bash" Method="remove">
    <INLINE>
        BUNDLE_V="&bundleversion;"
        PLUGIN_V="&version;"
        NAME="&name;"
        <![CDATA[
    # 1. ä½¿ç”¨ STOP_ONLY åœæ­¢æœåŠ¡ï¼šåªæ€è¿›ç¨‹ï¼Œä¸æ”¹é…ç½®
        if [ -x "/usr/local/emhttp/plugins/${NAME}/Daemon.sh" ]; then
        echo "æ­£åœ¨åœæ­¢ ${NAME} æœåŠ¡å¹¶ä¿ç•™è‡ªå¯åŠ¨çš„è®¾ç½®..."
        /usr/local/emhttp/plugins/${NAME}/Daemon.sh "STOP_ONLY" >/dev/null 2>&1
            sleep 2
        fi

    # 2. æ¸…ç†å…¶ä»–è¿›ç¨‹é€»è¾‘ (ä¿æŒä¸å˜)
        echo "æ¸…ç†æ®‹ç•™è¿›ç¨‹..."
        pkill -f "filebrowser_quantumorig" >/dev/null 2>&1
        pkill -f "log_stream.php" >/dev/null 2>&1
        pkill -f "tail -n 50 -f" >/dev/null 2>&1
        
        # 3. åˆ é™¤ç³»ç»Ÿè·¯å¾„ä¸‹çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œé“¾æ¥
        rm -f /usr/sbin/filebrowser_quantumorig
        rm -f /usr/sbin/filebrowser_quantum
        removepkg ${NAME}-${BUNDLE_V}-x86_64 >/dev/null 2>&1
        rm -f /var/lib/pkgtools/packages/${NAME}-*
        rm -rf /usr/local/emhttp/plugins/${NAME}
        echo "æ­£åœ¨æ¸…ç† U ç›˜ä¸Šçš„æ’ä»¶åŠŸèƒ½åŒ…..."
        rm -f /boot/config/plugins/${NAME}/install/${NAME}-${BUNDLE_V}-x86_64.txz
        echo ""
        echo "-----------------------------------------------------------"
        echo "${NAME} ${PLUGIN_V} å¸è½½æˆåŠŸï¼"
        echo "${NAME}äºŒè¿›åˆ¶ä¸»ç¨‹åºæ–‡ä»¶ä»ä¿ç•™åœ¨Uç›˜"
        echo "-----------------------------------------------------------"
        echo ""
        ]]>
    </INLINE>
  </FILE>

</PLUGIN>
