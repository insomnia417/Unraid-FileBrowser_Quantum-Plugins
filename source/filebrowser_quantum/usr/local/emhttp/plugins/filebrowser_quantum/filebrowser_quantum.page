Menu="Utilities"
Title="filebrowser_quantum"
Icon="filebrowser_quantum.png"
---
<?PHP
/* Copyright 2005-2016, Lime Technology
 * Copyright 2012-2016, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
> Use this page to make changes to your `config.yaml` file as well as update filebrowser_quantum if a newer version is available.
>
> To setup filebrowser_quantum for the first time execute the command `filebrowser_quantum config` in command line.


<script>
function updatefilebrowser_quantum(branch) {
   var path = "/usr/local/emhttp/plugins/filebrowser_quantum/updatefilebrowser_quantum.sh"
   openBox('/usr/local/emhttp/plugins/filebrowser_quantum/startScript.sh&arg1='+path+'&arg2='+branch,"Update filebrowser_quantum",450,800,true);
}

function webui(form) {
   var state = form.webui_status.value;
   // 弹窗执行 Daemon.sh
   // 注意：这里我们加入了一个回调，当弹窗关闭时，刷新当前页面
   openBox('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh&arg1='+state,"filebrowser_quantum WebUI",450,800,true);
   
   // 这是一个小技巧：当窗口重新获得焦点（通常是黑窗口关闭后），自动刷新页面
   $(window).once('focus', function() {
       window.location.reload();
   });
}
</script>

<?
// --- A. 基础路径定义 ---
$file = "/boot/config/plugins/filebrowser_quantum/config.yaml";
$defaultfile = "/boot/config/plugins/filebrowser_quantum/config.yaml";
$settings_file = '/boot/config/plugins/filebrowser_quantum/settings.cfg';
$latest_file = '/boot/config/plugins/filebrowser_quantum/install/latest';
$beta_marker = '/boot/config/plugins/filebrowser_quantum/install/beta';

// --- B. 处理分支切换逻辑 (必须在读取版本号之前执行) ---
// 1. 先探测磁盘上的实际状态
$branch = file_exists($beta_marker) ? "2" : "1";

// 2. 如果用户提交了新选择，则更新状态并立即重新拉取云端版本
if (isset($_POST['branch']) && $_POST['branch'] != $branch) {
    $branch = $_POST['branch'];
    if ($branch == "1") {
        @unlink($beta_marker);
    } else {
        @touch($beta_marker);
    }
    // 分支变了，立刻同步云端最新版本号
    exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "VERSION"');
}

// --- C. 获取各种动态数据 ---
$text = file_get_contents($file);
$default_text = @file_get_contents($defaultfile);
$settings = parse_ini_file($settings_file);

// 获取端口,本地版本
$dynamic_port = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_PORT"');
$currentversion = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_LOCAL_VER"');

// 如果 latest 文件不存在，初始化一次
if (!file_exists($latest_file)) {
    exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "VERSION"');
}
$latestversion = @exec("head -n 1 $latest_file");
if (empty($latestversion)) $latestversion = "Unknown";

// 进程状态检测 (pgrep -f 匹配更精准)
$webui_pid = exec('pgrep -f "filebrowser_quantumorig"');

// --- Section D: 接管配置保存与重启逻辑 ---
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['save_config_btn'])) {
    // 1. 获取前端传来的新配置内容
    $new_content = $_POST['config_text'];
    
    // 2. 核心操作：手动将新内容写入 config.yaml 文件
    // 因为我们去掉了 action="/update.php"，所以必须由我们自己来写文件
    if (file_put_contents($file, $new_content) !== false) {
        
        // 3. 写入成功后，判断是否需要重启服务
        if ($settings['filebrowser_ENABLED'] == 'true') {
            exec("logger -t 'FileBrowser-Plugin' 'Manual config save. Restarting service...'");
            
            // 执行停止 (调用你的 Daemon.sh)
            exec("bash /usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh 'false' > /dev/null 2>&1");
            
            // 缓冲 2 秒确保旧进程退出、端口释放
            sleep(2);
            
            // 执行启动
            exec("bash /usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh 'true' > /dev/null 2>&1");
            
            // 弹出提示并刷新页面（确保页面看到的是最新 PID 和端口）
            echo "<script>alert('配置已成功保存，服务已重启！'); window.location.href=window.location.href;</script>";
        } else {
            // 如果服务本身是 Disabled，只保存文件，不启动
            echo "<script>alert('配置已保存！(当前服务未开启，无需重启)'); window.location.href=window.location.href;</script>";
        }
        exit;
    }
}
// ========================================================

?>

<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

.row {
  display: flex;
}

/* Create two unequal columns */
.column {
  padding: 10px;
}

.left {
  flex: 1; /* Represents 25% of the container */
}

.right {
  flex: 3; /* Represents 75% of the container */
}
</style>
</head>
<body>

<div class="row">
  <div class="column left">
    <h2>Branch</h2>

	<form action="" method="post"> 
	<select name="branch" onchange="this.form.submit();"> 
	<option value="1" <?php if($branch == 1) echo("selected")?>>Stable</option>
	<option value="2" <?php if($branch == 2) echo("selected")?>>Beta</option>
	</select> 
	</form> 
	<?
	echo "Installed version: $currentversion";
	echo "<br>";
	echo "Latest version:&emsp;&ensp;$latestversion";
	?>
	<br>
	<input type="button" value="升级filebrowser_quantum版本" <?php if ($currentversion == $latestversion){ ?> disabled <?php   } ?> onclick="updatefilebrowser_quantum('<?php echo $branch; ?>')">

<h2>服务
  <span style="font-size:0.6em; color: <?= !empty($webui_pid) ? 'green' : 'red' ?>;">
    &nbsp;&nbsp;&nbsp;<?= !empty($webui_pid) ? 'RUNNING' : 'STOPPED' ?>
  </span>
  </h2>

  <form action="" method="post"> 
    <select name="webui_status" onchange="this.form.apply_btn.disabled=false; this.form.apply_btn.className='submit';"> 
      <option value="false" <?php if($settings['filebrowser_ENABLED'] == 'false' || empty($settings['filebrowser_ENABLED'])) echo("selected")?>>Disabled</option>
      <option value="true" <?php if($settings['filebrowser_ENABLED'] == 'true' || $settings['filebrowser_ENABLED'] == '1') echo("selected")?>>Enabled</option>
    </select> 

    <br><br>
    <input type="button" name="apply_btn" value="Apply" disabled onclick="webui(this.form)">

    <? if (!empty($webui_pid)): ?>
      <input type="button" class="localURL" value="Open WebUI" onclick="window.open('http://<?= $_SERVER['SERVER_ADDR'] ?>:<?= $dynamic_port ?>', '_blank')" />
    <? endif; ?>
  </form>

  </div>

  <div class="column right">
    <h2>Edit config</h2>
  <form method="POST">
    <textarea spellcheck="false" cols="80" rows="22" name="config_text" 
    oninput="this.form.save_config_btn.style.color='#fff'; this.form.save_config_btn.style.background='#4caf50';" 
    style="font-family:bitstream;width:100%"><?=$text;?></textarea>
    <br>
    <input type="submit" name="save_config_btn" value="Apply" style="padding: 2px 20px; cursor: pointer;"/>
    <input type="button" value="Original" onclick="setDefault(this.form)">
  </form> 
</div>

</div>

</body>
</html>

<script>
function setDefault(form) {
  form.elements['config_text'].value = <?=json_encode($default_text);?>;
}
</script>

> Click the **Apply** button to commit the current edits.
>
> Click the **Original** button to initialize the edit box with the
> original contents.  You still need to click **Apply** in order to
> commit the change.
