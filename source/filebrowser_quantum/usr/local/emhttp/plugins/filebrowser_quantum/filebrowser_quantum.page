Menu="Utilities"
Title="filebrowser_quantum"
Icon="filebrowser_quantum.png"
---
<?PHP
/* Copyright 2005-2016, Lime Technology
 * Copyright 2012-2016, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
> Use this page to make changes to your `config.yaml` file as well as update filebrowser_quantum if a newer version is available.
>
> To setup filebrowser_quantum for the first time execute the command `filebrowser_quantum config` in command line.


<script>
function updatefilebrowser_quantum(branch) {
   var path = "/usr/local/emhttp/plugins/filebrowser_quantum/updatefilebrowser_quantum.sh"
   openBox('/usr/local/emhttp/plugins/filebrowser_quantum/startScript.sh&arg1='+path+'&arg2='+branch,"Update filebrowser_quantum",450,800,true);
}

function webui(form) {
   var state = form.webui_status.value;
   // 弹窗执行 Daemon.sh
   // 注意：这里我们加入了一个回调，当弹窗关闭时，刷新当前页面
   openBox('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh&arg1='+state,"filebrowser_quantum WebUI",450,800,true);
   // 当窗口重新获得焦点（通常是黑窗口关闭后），自动刷新页面
   $(window).once('focus', function() {
       window.location.reload();
   });
}
</script>

<?
// --- A. 基础路径定义 ---
$file = "/boot/config/plugins/filebrowser_quantum/config.yaml";
$defaultfile = "/boot/config/plugins/filebrowser_quantum/config.yaml";
$settings_file = '/boot/config/plugins/filebrowser_quantum/settings.cfg';
$latest_file = '/boot/config/plugins/filebrowser_quantum/install/latest';
$beta_marker = '/boot/config/plugins/filebrowser_quantum/install/beta';
$logfile = "/var/log/filebrowser_quantum.log"; 

// --- B. 处理分支切换逻辑 (必须在读取版本号之前执行) ---
// 1. 先探测磁盘上的实际状态
$branch = file_exists($beta_marker) ? "2" : "1";

// 2. 如果用户提交了新选择，则更新状态并立即重新拉取云端版本
if (isset($_POST['branch']) && $_POST['branch'] != $branch) {
    $branch = $_POST['branch'];
    if ($branch == "1") { @unlink($beta_marker); } else { @touch($beta_marker); }
    exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "VERSION"');
}
// --- C. 获取各种动态数据 ---
$text = file_get_contents($file);
$default_text = @file_get_contents($defaultfile);
$settings = parse_ini_file($settings_file);
// 获取端口,本地版本
$dynamic_port = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_PORT"');
$currentversion = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_LOCAL_VER"');
// 如果 latest 文件不存在，初始化一次
if (!file_exists($latest_file)) {
    exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "VERSION"'); }
$latestversion = @exec("head -n 1 $latest_file");
if (empty($latestversion)) $latestversion = "Unknown";
$webui_pid = exec('pgrep -f "filebrowser_quantumorig"');
// --- 日志处理逻辑 ---
$log_level = isset($_POST['log_level']) ? $_POST['log_level'] : 'all';
$grep_cmd = "";
if ($log_level !== 'all') {
    $grep_cmd = " | grep -i '$log_level'";
}
// 读取最后 50 行日志
$log_content = shell_exec("tail -n 50 $logfile $grep_cmd 2>&1") ?: "暂无日志或日志文件不存在: $logfile";

// --- D: 接管配置保存与重启逻辑 ---
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['save_config_btn'])) {
    $new_content = $_POST['config_text'];
    $daemon_path = "/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh";
    if (file_put_contents($file, $new_content) !== false) {
        // 依然检测进程，确保用户改完配置后能即时生效
        $is_running = !empty(exec('pgrep -f "filebrowser_quantumorig"'));
        $is_enabled = ($settings['filebrowser_ENABLED'] == 'true' || $settings['filebrowser_ENABLED'] == '1');

        if ($is_enabled || $is_running) {
            // 完全通过脚本处理重启逻辑，PHP 只管触发
            exec("bash $daemon_path 'false' > /dev/null 2>&1");
            sleep(2);
            exec("bash $daemon_path 'true' > /dev/null 2>&1");
            
            echo "<script>alert('配置已成功保存，服务已完成重启！'); window.location.href=window.location.href;</script>";
        } else {
            echo "<script>alert('配置已保存！(当前服务处于关闭状态)'); window.location.href=window.location.href;</script>";
        }
        exit;
    }
}
// ========================================================

?>

<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
.row { display: flex; flex-direction: column; }
.column { padding: 10px; width:100%; box-sizing: border-box; }

/* 2. 核心自适应：电脑端（宽度大于1024px）自动变横排 */
@media screen and (min-width: 1024px) {
  .row { flex-direction: row; flex-wrap: nowrap; }
  .left { flex: 0 0 220px; } 
  .mid { flex: 1; border-right: 1px solid #eee; border-left: 1px solid #eee; min-width: 350px; } 
  .right { flex: 1; min-width: 350px; position: relative; }
}

/* 3. 左侧控件统一宽度 */
.left input[type="button"], .left select, .right select {
  width: 200px !important;
  height: 28px;
  line-height: normal;
  margin-bottom: 5px;
  box-sizing: border-box;
  text-align: center;
}

/* --- 修改点 2: 强制下拉框漂浮到标题右侧，不占用垂直空间 --- */
.column.right form {
  position: absolute;
  top: 26px;      /* 调整这个值可以让下拉框上下对齐标题 */
  right: 15px;    /* 调整这个值让它靠右边 */
  margin: 0;
}

/* --- 修改点 3: 优化下拉框在标题栏的外观 --- */
.column.right select {
  width: 140px !important; /* 宽度调小一点更精致 */
  height: 28px;
  font-size: 15px !important;
  font-weight: bold !important;
  text-align-last: center;
}

/* 下拉框：加粗、加大字体 */
.left select {
  font-size: 15px !important;   /* 只让下拉框变大 */
  font-weight: bold !important; /* 只让下拉框加粗 */
  color: #000;
  text-align-last: center;      /* 文字在下拉框内居中 */
}

/* 按钮：保持原来的小字体，不加粗 */
.left input[type="button"] {
  font-size: 12px;              /* 按钮维持 12px */
  font-weight: bold;          /* 按钮不加粗 */
  cursor: pointer;
}

/* 版本信息区域的微调 */
.version-info {
  margin: 10px 0;             /* 上下留出一点间距 */
  font-family: 'Clear Sans', sans-serif;
  width: 200px;
}

.version-info div {
  clear: both; 
  padding: 6px 0; 
  border-bottom: 1px solid #eee;
  font-size: 12px; 
  color: #666;
  text-align: left; /* 确保左对齐 */
}
.version-info b {
  margin-left: 8px; /* 冒号后的间距 */
  float: none;     /* 取消之前的右浮动 */
}

/* --- 修改点 4: 确保日志框高度与配置框严格一致 --- */
.log-area {
  width: calc(100% - 2px); 
  box-sizing: border-box !important;
  overflow-x: hidden; 
  overflow-y: scroll;
  /* 其余保持不变 */
  height: 335px;
  margin-top: 11px;
  background: #1e1e1e;
  color: #dcdcdc;
  font-family: bitstream, 'Courier New', monospace;
  font-size: 13px;
  padding: 10px;
  border-radius: 3px;
  white-space: pre-wrap;
  border: 1px solid #333;
}
</style>

</head>
<body>

<div class="row">
  <div class="column left">
    <h2>Branch</h2>
	<form action="" method="post"> 
	<select name="branch" onchange="this.form.submit();"> 
	<option value="1" <?php if($branch == 1) echo("selected")?>>Stable</option>
	<option value="2" <?php if($branch == 2) echo("selected")?>>Beta</option>
	</select> 
	</form> 

<div class="version-info">
    <div>已安装版本: <b style="margin-left: 8px; color:#1a17d6;"><?=$currentversion?></b></div>
    <div>在线最新版: <b style="margin-left: 8px; color:#eb2b2b;"><?=$latestversion?></b></div>
</div>

	<br>
	<input type="button" value="UPDATE" <?php if ($currentversion == $latestversion){ ?> disabled <?php } ?> onclick="updatefilebrowser_quantum('<?php echo $branch; ?>')">

<h2>服务
  <span style="font-size:0.6em; color: <?= !empty($webui_pid) ? 'green' : 'red' ?>;">
    &nbsp;&nbsp;&nbsp;<?= !empty($webui_pid) ? 'RUNNING' : 'STOPPED' ?>
  </span>
  </h2>

  <form action="" method="post"> 
    <select name="webui_status" onchange="this.form.apply_btn.disabled=false; this.form.apply_btn.className='submit';"> 
      <option value="false" <?php if($settings['filebrowser_ENABLED'] == 'false' || empty($settings['filebrowser_ENABLED'])) echo("selected")?>>Disabled</option>
      <option value="true" <?php if($settings['filebrowser_ENABLED'] == 'true' || $settings['filebrowser_ENABLED'] == '1') echo("selected")?>>Enabled</option>
    </select> 

    <br><br>
    <input type="button" name="apply_btn" value="APPLY" disabled onclick="webui(this.form)">

    <? if (!empty($webui_pid)): ?>
      <input type="button" class="localURL" value="Open WebUI" onclick="window.open('http://<?= $_SERVER['SERVER_ADDR'] ?>:<?= $dynamic_port ?>', '_blank')" />
    <? endif; ?>
  </form>

  </div>

<div class="column mid">
  <h2>Edit config</h2>
  <form id="config_form" method="POST">
    <textarea spellcheck="false" name="config_text" 
      oninput="var btn=document.getElementById('SAVE_btn'); btn.style.background='#4caf50'; btn.style.color='#fff'; btn.style.borderColor='#4caf50';" 
      style="font-family:bitstream; width:100%; height:335px;"><?=$text;?></textarea>
    <br>
    
    <a id="SAVE_btn" href="javascript:void(0);" 
       onclick="if(confirm('确定要保存配置并重启服务吗？')){ document.getElementById('config_form').submit(); }"
       style="display: inline-block; 
              padding: 0 25px;            /* 增加左右内边距，让它变宽 */
              height: 32px;               /* 增加高度 */
              line-height: 30px;          /* 让文字垂直居中，比高度小2px即可 */
              background: #f2f2f2; 
              color: #333; 
              border: 1px solid #ccc; 
              cursor: pointer; 
              text-decoration: none; 
              border-radius: 2px; 
              font-family: 'Clear Sans', sans-serif; 
              font-size: 12px;            /* 字体保持你满意的状态 */
              font-weight: bold; 
              text-transform: uppercase; 
              letter-spacing: 2px; 
              box-sizing: border-box; 
              vertical-align: middle;">
       SAVE
    </a>

    <input type="hidden" name="save_config_btn" value="1">
    
    <input type="button" value="Original" onclick="setDefault(this.form)" style="margin-left: 10px; vertical-align: middle;">
  </form> 
</div>

  <div class="column right">
    <h2>Logging</h2>
    <form action="" method="post">
        <select name="log_level" onchange="this.form.submit();">
            <option value="all" <?= $log_level=='all'?'selected':'' ?>>LEVEL: ALL</option>
            <option value="info" <?= $log_level=='info'?'selected':'' ?>>LEVEL: INFO</option>
            <option value="error" <?= $log_level=='error'?'selected':'' ?>>LEVEL: ERROR</option>
        </select>
    </form>
    <div class="log-area"><?=htmlspecialchars($log_content)?></div>
    <input type="button" value="REFRESH LOG" onclick="window.location.reload();" style="margin-top:14px; width:200px;">
  </div>
</div>


</body>
</html>

<script>
function setDefault(form) {
  form.elements['config_text'].value = <?=json_encode($default_text);?>;
}
// 自动滚动逻辑：仅在页面加载完成后执行一次
$(document).ready(function() {
    var logArea = document.querySelector('.log-area');
    if (logArea) {
        logArea.scrollTop = logArea.scrollHeight;
    }
});
</script>

> Click the **Apply** button to commit the current edits.
>
> Click the **Original** button to initialize the edit box with the
> original contents.  You still need to click **Apply** in order to
> commit the change.
