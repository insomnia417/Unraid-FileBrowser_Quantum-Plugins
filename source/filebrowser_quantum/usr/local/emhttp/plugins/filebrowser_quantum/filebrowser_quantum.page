Menu="Utilities"
Title="filebrowser_quantum"
Icon="filebrowser_quantum.png"
---
<?PHP
/* Copyright 2005-2016, Lime Technology
 * Copyright 2012-2016, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
> Use this page to make changes to your `config.yaml` file as well as update filebrowser_quantum if a newer version is available.
>
> To setup filebrowser_quantum for the first time execute the command `filebrowser_quantum config` in command line.

<script>
function updatefilebrowser_quantum(branch) {
   var path = "/usr/local/emhttp/plugins/filebrowser_quantum/updatefilebrowser_quantum.sh"
   openBox('/usr/local/emhttp/plugins/filebrowser_quantum/startScript.sh&arg1='+path+'&arg2='+branch,"Update filebrowser_quantum",450,800,true);
}

function webui(form) {
   var state = form.webui_status.value;
   // --- 新增：UI 状态即时反馈逻辑 ---
   const statusLabel = $("#service_status_label");
   
   if (state === "true") {
       // 如果点击了 Enabled，虽然还没生效，但我们可以预设它变绿
       statusLabel.css("color", "green");
   } else {
       // 如果点击了 Disabled，预设变红并隐藏端口
       statusLabel.css("color", "red");
       // 注意：这里不需要再手动修改文字，因为 HTML 里已经固定显示 $dynamic_port 了
   }
   // --- 结束 ---
   // 弹窗执行 Daemon.sh
   // 注意：这里我们加入了一个回调，当弹窗关闭时，刷新当前页面
   openBox('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh&arg1='+state,"filebrowser_quantum WebUI",450,800,true);
   // 当窗口重新获得焦点（通常是黑窗口关闭后），自动刷新页面
   $(window).once('focus', function() {
       window.location.reload();
   });
}

// v2.0.1 - SSE Logic
var evtSource = null;

function startLogTail() {
    stopLogTail(); // 必须先断开旧的

    const logArea = document.querySelector('.log-area');
    if (logArea) {
        logArea.innerHTML = "正在切换日志级别..."; // [新增] 给用户直观反馈
    }

    const logLevel = $("select[name='log_level']").val() || 'all';
    
    // 3. 创建 SSE 对象（加上时间戳 t 防止浏览器或反代缓存请求）
    evtSource = new EventSource("/plugins/filebrowser_quantum/log_stream.php?level=" + logLevel + "&t=" + new Date().getTime());

    const logArea = document.querySelector('.log-area');

    evtSource.onmessage = function(e) {
        if (!logArea) return;
        
        // 自动滚动判断
        const isAtBottom = logArea.scrollHeight - logArea.scrollTop <= logArea.clientHeight + 80;
        
        // 使用 appendChild 追加日志行，更高效
        const newLog = document.createElement("span");
        newLog.innerHTML = e.data + "<br>"; 
        logArea.appendChild(newLog);

        if (isAtBottom) {
            logArea.scrollTop = logArea.scrollHeight;
        }
    };

    evtSource.onerror = function(err) {
        console.warn("SSE 连接中断，正在清理...");
        stopLogTail(); // 报错立即断开，不再重试，彻底解决 Nginx 报错循环
        if (logArea) {
            const statusNode = document.createElement("div");
            statusNode.innerHTML = "<br><b style='color:orange;'>[System] 已断开日志连接 (服务重启或卸载中)</b>";
            logArea.appendChild(statusNode);
        }
    };
}

function stopLogTail() {
    if (evtSource) {
        evtSource.close();
        evtSource = null;
        console.log("Log stream closed.");
    }
}

// 清空日志逻辑，清空后重新连接
function clearLog() {
    if (confirm('确定要清空所有日志内容吗？')) {
        $.post(window.location.href, { clear_log_ajax: "1" }, function() {
            $(".log-area").html("");
            // 清空后不需要重启 startLogTail，因为 tail -f 会自动感知文件变动
        });
    }
}

function changeBranch(selectElement) {
    const newBranch = selectElement.value;
    const latestText = $("#latest_ver_val");
    const updateBtn = $("#update_btn_id");
    
    // 【修复点 1】：不要依赖 PHP 变量，直接从页面上已经显示的“已安装版本”那一行取值
    // 假设你的“已安装版本”那个 <b> 标签没有 id，我们给它加一个，或者用下面的选择器
    const currentVer = $(".version-info div:first b").text().trim(); 

    latestText.css("opacity", "0.5").text("Checking...");
    updateBtn.prop("disabled", true); 

    $.post("/plugins/filebrowser_quantum/ajax_version.php", { branch: newBranch }, function(data) {
        const latestVer = data.trim();

        // 更新 UI 上的在线版本号
        latestText.text(latestVer).css("opacity", "1");

        // 【调试大法】：如果你发现还是不行，请按 F12 检查控制台
        console.log("Current:", currentVer, "Latest:", latestVer);

        // 【修复点 2】：增加严格的逻辑判断
        if (latestVer !== "Unknown" && latestVer !== "" && latestVer !== currentVer) {
            updateBtn.prop("disabled", false);
            updateBtn.attr("onclick", "updatefilebrowser_quantum('" + newBranch + "')");
        } else {
            updateBtn.prop("disabled", true);
            updateBtn.removeAttr("onclick"); 
        }
    });
}

// 页面加载后立即启动
$(document).ready(function() {
    startLogTail();
});

// 页面离开或关闭时自动断连 , 管理生命周期
$(window).on('beforeunload', function() {
    stopLogTail();
});

</script>

<?PHP
// --- A. 路径与基础数据 ---
// 引入基础定义后，$CONFIG_YAML, $SETTINGS_FILE, $INSTALL_PATH 等变量直接可用
require_once "/usr/local/emhttp/plugins/filebrowser_quantum/base.php";

$config_text = file_get_contents($CONFIG_YAML); // config.yaml文本
$default_config_text = $config_text; // 用于 修改conifg.yaml的时候的重置按钮

// 2. 动态解析日志路径 (从 YAML 中提取)
$logfile = getLogPath($CONFIG_YAML);

// --- B. 处理清空日志请求 (AJAX 专属逻辑) ---
if (isset($_POST['clear_log_ajax'])) {
    if (file_exists($logfile)) {
        file_put_contents($logfile, ""); // 清空文件内容
    }
    // 关键：直接退出，不要让 PHP 继续往下执行 HTML 渲染
    echo "success"; 
    exit;
}

// --- C. 更新版本分支逻辑 ---
$branch = file_exists($BETA_MARKER) ? "2" : "1";

// --- D. 动态数据获取 ---
$settings = @parse_ini_file($SETTINGS_FILE);
$dynamic_port = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_PORT"');
$currentversion = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_LOCAL_VER"');
// 直接从 settings.cfg 读缓存.只有当第一次安装，缓存完全不存在时才跑一次
$latestversion = $settings['filebrowser_LATEST'] ?? "Unknown";

if ($latestversion == "Unknown") {
    $latestversion = exec($DAEMON_SCRIPT . ' "VERSION"');
}
// 获取 WebUI 进程 PID
$webui_pid = exec('pgrep -f "' . basename($BINARY) . '"');
// 日志初始内容
$log_level = isset($_POST['log_level']) ? $_POST['log_level'] : 'all';
$grep_cmd = ($log_level !== 'all') ? " | grep -i ".escapeshellarg($log_level) : "";


// --- E. 保存配置逻辑 ---
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['save_config_btn'])) {
    $new_content = $_POST['config_text'];
    $daemon_path = "/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh";
    if (file_put_contents($CONFIG_YAML, $new_content) !== false) {
        // 依然检测进程，确保用户改完配置后能即时生效
        $is_running = !empty(exec('pgrep -f "' . basename($BINARY) . '"'));
        $is_enabled = ($settings['filebrowser_ENABLED'] == 'true' || $settings['filebrowser_ENABLED'] == '1');
        if ($is_enabled || $is_running) {
            exec("bash $daemon_path 'false' > /dev/null 2>&1");
            sleep(2);
            exec("bash $daemon_path 'true' > /dev/null 2>&1");
            echo "<script>alert('配置已保存并重启服务！'); window.location.href=window.location.href;</script>";
        } else {
            echo "<script>alert('配置已保存！'); window.location.href=window.location.href;</script>";
        }
        exit;
    }
}
// ========================================================

?>

<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
.row { display: flex; flex-direction: column; }
.column { padding: 10px; width:100%; box-sizing: border-box; }

/* 3. 控件统一宽度 */
.left input[type="button"], .left select, .right select {
  width: 200px !important;
  height: 28px;
  line-height: normal;
  margin-bottom: 5px;
  box-sizing: border-box;
  text-align: center;
  cursor: pointer;
}

/* --- 修改点 2: 强制下拉框漂浮到标题右侧，不占用垂直空间 --- */
.column.right form {
  position: relative; 
  top: 0;
  right: 0;
  margin: 10px 0;    /* 标题和日志框之间留出间距 */
  text-align: left;  /* 在手机端左对齐 */
}

/* --- 修改点 3: 优化下拉框在标题栏的外观 --- */
.column.right select {
  width: 200px !important; 
  height: 28px;
  font-size: 15px !important;
  font-weight: bold !important;
  text-align-last: center;
}

/* ======================================================== */
/* 2. 紧接着写电脑端样式 (只有屏幕够宽时才会“覆盖”上面的样式)     */
/* ======================================================== */
@media screen and (min-width: 1024px) {
  .row { flex-direction: row; flex-wrap: nowrap; }
  .left { flex: 0 0 220px; } 
  .mid { flex: 1; border-right: 1px solid #eee; border-left: 1px solid #eee; min-width: 350px; } 
  .right { flex: 1; min-width: 350px; position: relative; }

  /* 电脑端执行：开启绝对定位，让下拉框“飞”到 Logging 标题右侧 */
  .column.right form {
    position: absolute;
    top: 26px;      /* 你的黄金坐标 */
    right: 15px;    
    margin: 0;
  }

  /* 电脑端执行：下拉框宽度变窄，更精致 */
  .column.right select {
    width: 140px !important; 
  }
} /* <--- 确认这里有一个结束的大括号 */

/* 下拉框：加粗、加大字体 */
.left select {
  font-size: 15px !important;   /* 只让下拉框变大 */
  font-weight: bold !important; /* 只让下拉框加粗 */
  color: #000;
  text-align-last: center;      /* 文字在下拉框内居中 */
}

/* 按钮：保持原来的小字体，不加粗 */
.left input[type="button"] {
  font-size: 12px;              /* 按钮维持 12px */
  font-weight: bold;          /* 按钮不加粗 */
  cursor: pointer;
}

/* 版本信息区域的微调 */
.version-info {
  margin: 10px 0;             /* 上下留出一点间距 */
  font-family: 'Clear Sans', sans-serif;
  width: 200px;
}

.version-info div {
  clear: both; 
  padding: 6px 0; 
  border-bottom: 1px solid #eee;
  font-size: 12px; 
  color: #666;
  text-align: left; /* 确保左对齐 */
}
.version-info b {
  margin-left: 8px; /* 冒号后的间距 */
  float: none;     /* 取消之前的右浮动 */
}

/* --- 修改点 4: 确保日志框高度与配置框严格一致 --- */
.log-area {
  width: calc(100% - 2px); 
  box-sizing: border-box !important;
  overflow-x: hidden; 
  overflow-y: scroll;
  /* 其余保持不变 */
  height: 500px;
  margin-top: 11px;
  background: #1e1e1e;
  color: #dcdcdc;
  font-family: bitstream, 'Courier New', monospace;
  font-size: 13px;
  padding: 10px;
  border-radius: 3px;
  white-space: pre-wrap;
  border: 1px solid #333;
  word-wrap: break-word;      /* 强制长单词换行 */
  overflow-wrap: break-word;  /* 兼容性更好的换行属性 */
}
</style>
</head>
<body>

<div class="row">
  <div class="column left">
    <h2>Branch</h2>
	<form action="" method="post"> 
  <select name="branch" onchange="changeBranch(this);"> 
      <option value="1" <?php if($branch == 1) echo("selected")?>>Stable</option>
      <option value="2" <?php if($branch == 2) echo("selected")?>>Beta</option>
  </select>
	</form> 

<div class="version-info">
    <div>已安装版本: <b style="margin-left: 8px; color:#1a17d6;"><?=trim($currentversion)?></b></div>
    <div>在线最新版: <b id="latest_ver_val" style="margin-left: 8px; color:#eb2b2b;"><?=trim($latestversion)?></b></div>
</div>

	<br>
	<input type="button" id="update_btn_id" value="UPDATE" 
    <?php if (trim($currentversion) == trim($latestversion) || $latestversion == "Unknown"){ ?> disabled <?php } ?> 
    onclick="updatefilebrowser_quantum('<?php echo $branch; ?>')">

<h2>服务
  <span id="service_status_label" style="font-size:0.6em; color: <?= !empty($webui_pid) ? 'green' : 'red' ?>;">
    &nbsp;&nbsp;&nbsp;<?= !empty($webui_pid) ? 'RUNNING' : 'STOPPED' ?>
    <span id="port_val" style="margin-left: 10px;">
        (PORT: <?= $dynamic_port ?>)
    </span>
  </span>
</h2>

  <form action="" method="post"> 
    <select name="webui_status" onchange="this.form.apply_btn.disabled=false; this.form.apply_btn.className='submit';"> 
      <option value="false" <?php if($settings['filebrowser_ENABLED'] == 'false' || empty($settings['filebrowser_ENABLED'])) echo("selected")?>>Disabled</option>
      <option value="true" <?php if($settings['filebrowser_ENABLED'] == 'true' || $settings['filebrowser_ENABLED'] == '1') echo("selected")?>>Enabled</option>
    </select> 

    <br><br>
    <input type="button" name="apply_btn" value="APPLY" disabled onclick="webui(this.form)">

    <? if (!empty($webui_pid)): ?>
      <input type="button" class="localURL" value="Open WebUI" onclick="window.open('http://<?= $_SERVER['SERVER_ADDR'] ?>:<?= $dynamic_port ?>', '_blank')" />
    <? endif; ?>
  </form>

  </div>

<div class="column mid">
  <h2>Edit config</h2>
  <form id="config_form" method="POST">
    <textarea 
      spellcheck="false" 
      name="config_text" 
      oninput="var btn=document.getElementById('SAVE_btn'); btn.style.background='#4caf50'; btn.style.color='#fff'; btn.style.borderColor='#4caf50';" 
      style="font-family:bitstream, monospace; width:100%; height:500px; padding:10px; box-sizing:border-box;"
    ><?=htmlspecialchars($config_text);?></textarea>

    <br><br> <a id="SAVE_btn" href="javascript:void(0);" 
       onclick="if(confirm('确定要保存配置并重启服务吗？')){ document.getElementById('config_form').submit(); }"
       style="display: inline-block; 
              padding: 0 25px;            /* 增加左右内边距，让它变宽 */
              height: 32px;               /* 增加高度 */
              line-height: 30px;          /* 让文字垂直居中，比高度小2px即可 */
              background: #f2f2f2; 
              color: #333; 
              border: 1px solid #ccc; 
              cursor: pointer; 
              text-decoration: none; 
              border-radius: 2px; 
              font-family: 'Clear Sans', sans-serif; 
              font-size: 12px;            /* 字体保持你满意的状态 */
              font-weight: bold; 
              text-transform: uppercase; 
              letter-spacing: 2px; 
              box-sizing: border-box; 
              vertical-align: middle;">
       SAVE
    </a>

    <input type="hidden" name="save_config_btn" value="1">
    
    <input type="button" value="Original" onclick="setDefault(this.form)" style="margin-left: 10px; vertical-align: middle;">
  </form> 
</div>

  <div class="column right">
    <h2>Logging</h2>
    <form class="level-form" onsubmit="return false;">
        <?php $available_levels = getLogLevels($CONFIG_YAML); ?>
        <select name="log_level" onchange="startLogTail();">
            <option value="all" <?=$log_level=='all'?'selected':''?>>LEVEL: ALL</option>
            <?php foreach($available_levels as $level): ?>
                <?php if(empty($level)) continue; ?>
                <option value="<?=$level?>" <?=$log_level==$level?'selected':''?>>
                    LEVEL: <?=strtoupper($level)?>
                </option>
            <?php endforeach; ?>
        </select>
    </form>
    <div class="log-area">正在连接实时日志流...</div>
    
    <div style="margin-top:24px;">
        <input type="button" value="CLEAR LOG" onclick="clearLog();">
    </div>
  </div>
</div>

</body>
</html>

<script>
function setDefault(form) {
  form.elements['config_text'].value = <?=json_encode($default_config_text);?>;
}
// 自动滚动逻辑：仅在页面加载完成后执行一次
$(document).ready(function() {
    var logArea = document.querySelector('.log-area');
    if (logArea) {
        logArea.scrollTop = logArea.scrollHeight;
    }
});
</script>

> Click the **Apply** button to commit the current edits.
>
> Click the **Original** button to initialize the edit box with the
> original contents.  You still need to click **Apply** in order to
> commit the change.
