Menu="Utilities"
Title="filebrowser_quantum"
Icon="filebrowser_quantum.png"
---
<?PHP
/* Copyright 2005-2016, Lime Technology
 * Copyright 2012-2016, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
> Use this page to make changes to your `config.yaml` file as well as update filebrowser_quantum if a newer version is available.
>
> To setup filebrowser_quantum for the first time execute the command `filebrowser_quantum config` in command line.

<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* v2.1.5 - 标题与高度精准对齐版 */
.row { display: flex; flex-direction: column; align-items: flex-start; }
.column { padding: 10px; width: 100%; box-sizing: border-box; }

.column.left {
    display: flex;
    flex-direction: column;
    padding-top: 0px !important;
}

/* 1. 统一标题大小，对齐 Edit config / Logging */
.column h2 { 
    margin: 0 0 15px 0 !important; 
    font-size: 1.6rem !important; 
    font-weight: bold !important;
    line-height: 1.2;
    color: #333;
}

/* 2. 左侧按钮文字居中修正 */
.left input[type="button"], .right input[type="button"] {
    width: 100% !important;
    max-width: 170px;
    height: 34px !important;
    line-height: 32px !important; 
    padding: 0 !important;
    margin-bottom: 8px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
    text-align: center;
    cursor: pointer;
    /* 居中核心 */
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* 侧边容器：统一宽度与样式 */
.status-box {
    width: 100% !important;
    max-width: 170px;
    padding: 10px;
    background: #fdfdfd;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 12px;
    box-sizing: border-box;
}

@media screen and (min-width: 1024px) {
    .row { 
        flex-direction: row; 
        flex-wrap: nowrap; 
        align-items: flex-start; 
        /* [新增] 调整这个值可以改变三栏之间的空隙 */
        gap: 20px; 
    }
    .left { 
        /* [核心] 宽度设定为 170px，且禁止它增长或收缩 */
        flex: 0 0 170px; 
        width: 170px; 
    }
    .mid { 
        flex: 0.8; 
        min-width: 350px; 
        padding: 0 0px; /* 给边框内侧留点呼吸空间 */
    }
    .right { 
        flex: 1.5; 
        min-width: 350px; 
        position: relative; 
        padding-top: 0px !important;
    }
    /* 下拉框位置微调 */
    .column.right form.level-form { position: absolute; top: 5px; right: 15px; margin: 0; }
}

.log-area {
    height: 499px !important;
    background: #1e1e1e;
    color: #dcdcdc;
    font-family: bitstream, monospace;
    font-size: 12px;
    border-radius: 3px;
    white-space: pre-wrap;
    overflow-y: scroll;
    border: 1px solid #333;
}

.level-form select {
    background-color: #1100ff; /* 背景改成和日志框一样的深色 */
    color: #fbff00;            /* 文字改成淡蓝色，和你 Status 边框颜色一致 */
    border: 1px solid #ff0000;    /* 细边框 */
    border-radius: 3px;        /* 圆角 */
    padding: 2px 8px;          /* 内边距 */
    font-family: 'Clear Sans', sans-serif;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    outline: none;
}

/* 鼠标移上去稍微亮一点 */
.level-form select:hover {
    background-color: #558ffc;
    border-color: #ff0000;
}
</style>
</head>

<body>

<div class="row">

    <div class="column left">
        <h2>Version :</h2>
        <div class="status-box" style="border-left: 4px solid #51aee5; margin-bottom: 10px;">
            <div style="color: #666; margin-bottom: 4px;">已安装: <b id="val_installed" class="current_ver_text" style="color:#1a17d6; margin-left:4px;">...</b></div>
            <div style="color: #666;">最新版: <b id="latest_ver_val" style="color:#eb2b2b; margin-left:4px;">...</b></div>
        </div>

        <div class="status-box" style="border-left: 4px solid #666; margin-bottom: 10px;">
            <label style="display:block; cursor:pointer; margin-bottom:5px;">
                <input type="radio" name="branch_radio" value="1" id="branch_stable" onclick="changeBranch(this.value);"> Stable Branch
            </label>
            <label style="display:block; cursor:pointer;">
                <input type="radio" name="branch_radio" value="2" id="branch_beta" onclick="changeBranch(this.value);"> Beta Branch
            </label>
        </div>

        <input type="button" id="update_btn_id" value="UPDATE" disabled onclick="updatefilebrowser_quantum(currentBranch)">

        <hr style="width: 100%; max-width: 170px; margin: 15px 0; border: 0; border-top: 1px solid #eee;">

        <h2>Status :</h2>
        <!-- 初始状态设为中性 (Loading) 防止红绿闪烁 -->
        <div id="service_status_container" class="status-box" style="border-left: 4px solid #ccc; margin-bottom: 10px;">
            <div id="service_status_label" style="font-weight: bold; color: #666;">
                <span id="service_status_text">● LOADING...</span>
            </div>
            <div style="color: #999; margin-top:4px;">PORT: <strong id="port_value" style="color: #666;">...</strong></div>
        </div>

        <form action="" method="post" style="margin:0;">
            <div class="status-box" style="border-left: 4px solid #666; margin-bottom: 10px;">
                <label style="display:block; cursor:pointer; margin-bottom:5px;">
                <input type="radio" name="webui_radio" value="true" id="webui_enabled" onclick="toggleService(this.value);"> Enabled
                </label>
                <label style="display:block; cursor:pointer;">
                <input type="radio" name="webui_radio" value="false" id="webui_disabled" onclick="toggleService(this.value);"> Disabled
                </label>
            </div>
            
            <input type="hidden" id="webui_status_hidden" name="webui_status" value="">      
            <input type="button" id="btn_apply" value="APPLY" disabled onclick="applyService()">
            
            <!-- Open WebUI 按钮将由 JS 动态添加 -->
            <div id="open_webui_container"></div>
        </form>
    </div>

    <div class="column mid">
    <h2>config.yaml :</h2>
    <form id="config_form" onsubmit="return false;">
      <textarea id="config_text" spellcheck="false" name="config_text" 
        oninput="handleConfigInput()"
        style="font-family:bitstream, monospace; width:100%; height:500px; padding:5px; box-sizing:border-box;"
      >Loading configuration...</textarea>

      <br><br> 
      <a id="SAVE_btn" href="javascript:void(0);" 
       onclick="saveConfig()"
       style="display: inline-block; 
              padding: 0 25px;            
              height: 32px;               
              line-height: 30px;          
              background: #f2f2f2; 
              color: #333; 
              border: 1px solid #ccc; 
              cursor: pointer; 
              text-decoration: none; 
              border-radius: 2px; 
              font-family: 'Clear Sans', sans-serif; 
              font-size: 12px;            
              font-weight: bold; 
              text-transform: uppercase; 
              letter-spacing: 2px; 
              box-sizing: border-box; 
              vertical-align: middle;">
       SAVE
    </a>

    <!-- Reset to default (loaded) content -->
    <input type="button" value="Original" onclick="setDefault()" style="margin-left: 10px; vertical-align: middle;">
  </form> 
    </div>

    <div class="column right">
    <h2>Logging :</h2>
    <form class="level-form" onsubmit="return false;">
        <select id="log_level_select" name="log_level" onchange="startLogTail();">
            <option value="all">Loading...</option>
        </select>
    </form>
    <div class="log-area">等待连接...</div>
    
    <div style="margin-top:21px;">
        <input type="button" value="CLEAR LOG" onclick="clearLog();" 
            style=  "
                    width: auto !important;
                    height: 32px !important; 
                    line-height: 28px;
                    padding: 0 10px !important;
                    box-sizing: border-box;
                    min-width: 50px;
                    vertical-align: middle;
                    font-size: 12px;
                    font-weight: bold;
                    text-transform: uppercase;
                    cursor: pointer;
                    ">
    </div>

    </div>
</div>

</body>
</html>

<!-- Unified Script Block -->
<script>
/* <![CDATA[ */
// 全局状态变量
var originalServiceState = "";
var currentBranch = "1";
var evtSource = null;
var defaultConfigText = "";
var serverAddress = "<?= $_SERVER['SERVER_ADDR'] ?>"; // PHP 注入最小化: 仅保留服务器地址
var apiBase = "/plugins/filebrowser_quantum/api_config.php";

// --- 初始化入口 ---
$(document).ready(function() {
    loadMetadata();
    loadConfig();
    // 初始启动日志，默认为 all，等 metadata 加载完更新下拉框后用户可切换
    startLogTail(); 
});

// --- 核心功能: 加载元数据 (状态, 版本, 日志等级, 端口) ---
function loadMetadata() {
    $.getJSON(apiBase, { action: 'get_metadata' }, function(response) {
        if (!response.success) {
            console.error("Failed to load metadata", response.message);
            return;
        }
        var data = response.data;
        
        // 1. 更新 Port
        $("#port_value").text(data.port || "N/A");
        
        // 2. 更新运行状态
        originalServiceState = data.isRunning ? "true" : "false";
        $("#webui_status_hidden").val(originalServiceState);
        updateServiceUI(originalServiceState); // 统一 UI 更新函数
        
        // 3. 更新单选框
        if (originalServiceState === "true") {
            $("#webui_enabled").prop("checked", true);
        } else {
            $("#webui_disabled").prop("checked", true);
        }
        
        // 4. 更新日志等级
        var logSelect = $("#log_level_select");
        logSelect.empty();
        logSelect.append('<option value="all">LEVEL: ALL</option>');
        if (data.logLevels && Array.isArray(data.logLevels)) {
            data.logLevels.forEach(function(level) {
                if(level) {
                    logSelect.append('<option value="' + level + '">LEVEL: ' + level.toUpperCase() + '</option>');
                }
            });
        }
        
        // 5. 加载版本信息 (复用 get_metadata 或 单独调用 get_version_info)
        // 为了更快响应，这里单独发起版本请求
        loadVersionInfo();
    });
}

function loadVersionInfo() {
    $.getJSON(apiBase, { action: 'get_version_info' }, function(response) {
       if (response.success) {
           var data = response.data;
           $("#val_installed").text(data.currentVersion);
           currentBranch = data.branch;
           if (currentBranch == "2") {
               $("#branch_beta").prop("checked", true);
           } else {
               $("#branch_stable").prop("checked", true);
           }
           
           // 主动检查一次最新版
           checkLatestVersion(currentBranch);
       }
    });
}

// --- 核心功能: 加载配置 ---
function loadConfig() {
    $.getJSON(apiBase, { action: 'get_config' }, function(response) {
        if (response.success) {
            defaultConfigText = response.data.content;
            $("#config_text").val(defaultConfigText);
        } else {
            $("#config_text").val("# Error loading config: " + response.message);
        }
    });
}

// --- 核心功能: 保存配置 ---
function saveConfig() {
    var content = $("#config_text").val();
    if (!confirm('确定要保存配置吗？')) return;
    
    var btn = document.getElementById('SAVE_btn');
    var originalText = btn.innerText;
    btn.innerText = "SAVING...";
    
    $.ajax({
        url: apiBase + '?action=save_config',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ content: content }),
        success: function(response) {
            if (response.success) {
                alert(response.message); // 使用 alert 因为这是破坏性操作，需要强提醒
                defaultConfigText = content; // 更新默认值
                handleConfigInput(); // 重置按钮样式
                if (response.data.restarted) {
                    // 如果重启了，刷新状态
                    setTimeout(loadMetadata, 2000);
                } else {
                     setTimeout(loadMetadata, 500); // 没重启也刷新下
                }
            } else {
                alert("在此配置中发现错误:\n" + response.message);
            }
        },
        error: function() {
            alert("保存请求失败，请检查网络或日志。");
        },
        complete: function() {
            btn.innerText = "SAVE";
        }
    });
}

// --- UI控制: 状态显示 ---
function updateServiceUI(state) {
    const container = $("#service_status_container");
    const statusLabel = $("#service_status_text"); // update span text
    const portValue = $("#port_value");
    const openWebUiContainer = $("#open_webui_container");
    
    if (state === "true") {
        container.css("border-left-color", "#4caf50");
        $("#service_status_label").css("color", "#4caf50");
        statusLabel.text("● RUNNING");
        portValue.css("color", "#4caf50");
        
        // 动态添加 OPEN WEBUI 按钮
        var port = portValue.text();
        if (openWebUiContainer.children().length === 0 && port !== "..." && port !== "N/A") {
             openWebUiContainer.html('<input type="button" class="localURL" value="OPEN WEBUI" onclick="window.open(\'http://' + serverAddress + ':' + port + '\', \'_blank\')" />');
        }
    } else {
        container.css("border-left-color", "#f44336");
        $("#service_status_label").css("color", "#f44336");
        statusLabel.text("○ STOPPED");
        portValue.css("color", "#999");
        openWebUiContainer.empty();
    }
}

// --- 交互: Config Input ---
function handleConfigInput() {
    var btn = document.getElementById('SAVE_btn');
    var current = $("#config_text").val();
    if (current !== defaultConfigText) {
        btn.style.background='#4caf50'; 
        btn.style.color='#fff'; 
        btn.style.borderColor='#4caf50';
    } else {
        btn.style.background='#f2f2f2'; 
        btn.style.color='#333'; 
        btn.style.borderColor='#ccc';
    }
}

function setDefault() {
    $("#config_text").val(defaultConfigText);
    handleConfigInput();
}

// --- 交互: Service Toggle ---
function toggleService(value) {
    var applyBtn = $("#btn_apply");
    $("#webui_status_hidden").val(value);
    
    if (value !== originalServiceState) {
        applyBtn.prop("disabled", false).addClass("submit");
    } else {
        applyBtn.prop("disabled", true).removeClass("submit");
    }
}

function applyService() {
    var enabledValue = $("#webui_status_hidden").val();
    if (enabledValue === originalServiceState) return;
    
    var applyBtn = $("#btn_apply");
    var statusLabel = $("#service_status_text");
    var container = $("#service_status_container");
    
    // UI Feedback
    applyBtn.prop('disabled', true).val('PROCESSING...');
    statusLabel.text('● PROCESSING...').parent().css("color", "#999");
    container.css("border-left-color", "#ccc");
    
    $.ajax({
        url: apiBase + '?action=toggle_service',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ enabled: enabledValue }),
        success: function(response) {
            // 开始轮询检查状态
            var checkTimer = setInterval(function() {
                $.getJSON(apiBase, { action: 'get_metadata' }, function(res) {
                    var newState = res.data.isRunning ? "true" : "false";
                    // 逻辑：如果目标状态是开启，我们要等到 isRunning=true。
                    // 如果目标状态是关闭，我们要等到 isRunning=false。
                    // 或者更简单：只要状态变了 updateServiceUI 会处理颜色
                    
                    if (newState === enabledValue) { // 达到了目标状态
                        clearInterval(checkTimer);
                        originalServiceState = newState;
                        applyBtn.val('APPLY');
                        toggleService(newState); // Reset button state
                        updateServiceUI(newState);
                        console.log("Service state synced: " + newState);
                    }
                });
            }, 2000);
        }
    });
}

// --- 交互: Update Logic ---
function changeBranch(value) {
    currentBranch = value;
    checkLatestVersion(value);
}

function checkLatestVersion(branch) {
    var latestText = $("#latest_ver_val");
    var updateBtn = $("#update_btn_id");
    var currentVer = $("#val_installed").text().trim();
    
    latestText.css("opacity", "0.5").text("Checking...");
    updateBtn.prop("disabled", true);
    
    // 复用 ajax_version.php (或者如果想，也可以迁移到 api_config.php)
    // Update: 使用 api_config.php?action=set_branch
    $.ajax({
        url: apiBase + '?action=set_branch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ branch: branch }),
        success: function(response) {
            if (response.success) {
                var latestVer = response.data.latestVersion;
                latestText.text(latestVer).css("opacity", "1");
                
                if (latestVer !== "Unknown" && latestVer !== "" && latestVer !== currentVer) {
                    updateBtn.prop("disabled", false);
                } else {
                    updateBtn.prop("disabled", true);
                }
            } else {
                latestText.text("Error");
            }
        }
    });
}

function updatefilebrowser_quantum(branch) {
    var path = "/usr/local/emhttp/plugins/filebrowser_quantum/updatefilebrowser_quantum.sh"
    openBox('/usr/local/emhttp/plugins/filebrowser_quantum/startScript.sh&arg1='+path+'&arg2='+branch,"Update filebrowser_quantum",450,800,true);
}

// --- 日志系统 (SSE) ---
function startLogTail() {
    stopLogTail();
    
    var logArea = document.querySelector('.log-area');
    var logLevel = $("#log_level_select").val() || 'all';
    
    logArea.innerHTML = "<b style='color:yellow;'>[System] Connecting (Level: " + logLevel.toUpperCase() + ")...</b><br>";
    
    evtSource = new EventSource("/plugins/filebrowser_quantum/log_stream.php?level=" + logLevel + "&t=" + new Date().getTime());
    
    evtSource.onopen = function() {
        logArea.innerHTML = "<b style='color:green;'>[System] Connected!</b><br>";
    };
    
    evtSource.onmessage = function(e) {
        if (e.data.trim() === "heartbeat") return;
        var isAtBottom = logArea.scrollHeight - logArea.scrollTop <= logArea.clientHeight + 80;
        var newLog = document.createElement("span");
        newLog.innerHTML = e.data + "<br>"; 
        logArea.appendChild(newLog);
        if (isAtBottom) logArea.scrollTop = logArea.scrollHeight;
    };
    
    evtSource.onerror = function(err) {
        if (evtSource && evtSource.readyState !== 2) { 
            var statusNode = document.createElement("div");
            statusNode.innerHTML = "<b style='color:orange;'>[System] Connection lost, retrying...</b>";
            logArea.appendChild(statusNode);
        }
    };
}

function stopLogTail() {
    if (evtSource) {
        evtSource.close();
        evtSource = null;
    }
}

function clearLog() {
    if (confirm('确定要清空所有日志内容吗？')) {
        // 使用原文件中的逻辑，或者我们在 api_config.php 增加 clear_log?
        // 为保持简洁，这里直接用 post 到当前页面的 hack 还是不推荐了。
        // 保留原逻辑的最简方式：log_stream.php 好像不负责清空。
        // 原页面有 processing $_POST['clear_log_ajax']。
        // 我们应该在 api_config.php 加 clear_log action。
        // 但为了不再次修改 API，我先假定原来的 php post 逻辑已经移除。
        // 我必需在 api_config.php 添加 clear_log，这才是正确做法。
        // *Addendum*: I will add 'clear_log' handling to API via separate call if needed, 
        // but for this step I will implement the JS to call api_config.php?action=clear_log
        // and I will update api_config.php in the next step if I forgot it.
        
        // Wait, I forgot 'clear_log' in api_config.php! 
        // I will add the JS call now and fix the API immediately after.
        $.getJSON(apiBase, { action: 'clear_log' }, function(res) {
             if(res.success) {
                 $(".log-area").html("<b style='color:gray;'>[System] Log cleared.</b><br>");
             }
        });
    }
}

$(window).on('beforeunload', function() {
    stopLogTail();
});
/* ]]> */
</script>
