Menu="Utilities"
Title="filebrowser_quantum"
Icon="filebrowser_quantum.png"
---
<?PHP
/* Copyright 2005-2016, Lime Technology
 * Copyright 2012-2016, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
> Use this page to make changes to your `config.yaml` file as well as update filebrowser_quantum if a newer version is available.
>
> To setup filebrowser_quantum for the first time execute the command `filebrowser_quantum config` in command line.

<script>
function updatefilebrowser_quantum(branch) {
   var path = "/usr/local/emhttp/plugins/filebrowser_quantum/updatefilebrowser_quantum.sh"
   openBox('/usr/local/emhttp/plugins/filebrowser_quantum/startScript.sh&arg1='+path+'&arg2='+branch,"Update filebrowser_quantum",450,800,true);
}

function webui(form) {
    var state = document.getElementById('webui_status_hidden').value;
    const container = $("#service_status_container");
    const statusLabel = $("#service_status_label");
    const statusDot = $("#status_dot");
    const statusText = $("#status_text");
    
    // 即时反馈逻辑：让用户点击后立刻看到UI变化
    if (state === "true") {
        container.css("border-left-color", "#4caf50");
        statusLabel.css("color", "#4caf50");
        statusDot.text("●");
        statusText.text("STARTING...");
    } else {
        container.css("border-left-color", "#f44336");
        statusLabel.css("color", "#f44336");
        statusDot.text("○");
        statusText.text("STOPPING...");
    }
    
    openBox('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh&arg1='+state,"filebrowser_quantum WebUI",450,800,true);
    
    $(window).once('focus', function() {
        window.location.reload();
    });
}

// v2.0.3 - SSE Logic
var evtSource = null;

function startLogTail() {
    // 1. 彻底切断旧连接
    stopLogTail(); 

    const logArea = document.querySelector('.log-area');
    // 2. 清空旧日志，给用户直观反馈
    const logLevel = $("select[name='log_level']").val() || 'all';
    
    // 强制清空并显示连接中
    logArea.innerHTML = "<b style='color:yellow;'>[System] 正在请求 SSE 流 (Level: " + logLevel.toUpperCase() + ")...</b><br>";
    
    // 3. 创建新连接（t=时间戳强制刷新缓存）
    evtSource = new EventSource("/plugins/filebrowser_quantum/log_stream.php?level=" + logLevel + "&t=" + new Date().getTime());

    // [新增] 监听连接成功
    evtSource.onopen = function() {
        logArea.innerHTML = "<b style='color:green;'>[System] 实时日志连接成功！</b><br>";
    };

    evtSource.onmessage = function(e) {
        if (e.data.trim() === "heartbeat") return;
        
        const isAtBottom = logArea.scrollHeight - logArea.scrollTop <= logArea.clientHeight + 80;
        const newLog = document.createElement("span");
        newLog.innerHTML = e.data + "<br>"; 
        logArea.appendChild(newLog);

        if (isAtBottom) {
            logArea.scrollTop = logArea.scrollHeight;
        }
    };

    evtSource.onerror = function(err) {
        console.warn("SSE 中断");
        // 只有当不是因为用户手动关闭导致的错误才显示
        if (evtSource && evtSource.readyState !== 2) { 
            const statusNode = document.createElement("div");
            statusNode.innerHTML = "<b style='color:orange;'>[System] 连接已重置，正在尝试重新连接...</b>";
            logArea.appendChild(statusNode);
        }
    };
}

function stopLogTail() {
    if (evtSource) {
        evtSource.close();
        evtSource = null;
        console.log("Log stream closed.");
    }
}

// 清空日志逻辑，清空后重新连接
function clearLog() {
    if (confirm('确定要清空所有日志内容吗？')) {
        $.post(window.location.href, { clear_log_ajax: "1" }, function() {
            $(".log-area").html("");
            // 清空后不需要重启 startLogTail，因为 tail -f 会自动感知文件变动
        });
    }
}

// branch 切换逻辑: 单选按钮
function changeBranch(value) {
    const latestText = $("#latest_ver_val");
    const updateBtn = $("#update_btn_id");
    const currentVer = $(".current_ver_text").text().trim(); 
    latestText.css("opacity", "0.5").text("Checking...");
    updateBtn.prop("disabled", true); 
    $.post("/plugins/filebrowser_quantum/ajax_version.php", { branch: value }, function(data) {
        const latestVer = data.trim();
        latestText.text(latestVer).css("opacity", "1");
        if (latestVer !== "Unknown" && latestVer !== "" && latestVer !== currentVer) {
            updateBtn.prop("disabled", false);
            updateBtn.attr("onclick", "updatefilebrowser_quantum('" + value + "')");
        } else {
            updateBtn.prop("disabled", true);
            updateBtn.removeAttr("onclick"); 
        }
    });
}

// v2.1.3 适配 Radio 的 Service 切换
function toggleService(value) {
    const applyBtn = $("input[name='apply_btn']");
    applyBtn.prop("disabled", false).addClass("submit");
    $("#webui_status_hidden").val(value);
}

// 页面加载后立即启动
$(document).ready(function() {
    startLogTail();
});

// 页面离开或关闭时自动断连 , 管理生命周期
$(window).on('beforeunload', function() {
    stopLogTail();
});

</script>

<?PHP
// --- A. 路径与基础数据 ---
// 引入基础定义后，$CONFIG_YAML, $SETTINGS_FILE, $INSTALL_PATH 等变量直接可用
require_once "/usr/local/emhttp/plugins/filebrowser_quantum/base.php";

$config_text = file_get_contents($CONFIG_YAML); // config.yaml文本
$default_config_text = $config_text; // 用于 修改conifg.yaml的时候的重置按钮

// 2. 动态解析日志路径 (从 YAML 中提取)
$logfile = getLogPath($CONFIG_YAML);

// --- B. 处理清空日志请求 (AJAX 专属逻辑) ---
if (isset($_POST['clear_log_ajax'])) {
    if (file_exists($logfile)) {
        file_put_contents($logfile, ""); // 清空文件内容
    }
    // 关键：直接退出，不要让 PHP 继续往下执行 HTML 渲染
    echo "success"; 
    exit;
}

// --- C. 更新版本分支逻辑 ---
$branch = file_exists($BETA_MARKER) ? "2" : "1";

// --- D. 动态数据获取 ---
$settings = @parse_ini_file($SETTINGS_FILE);
$dynamic_port = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_PORT"');
$currentversion = exec('/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh "GET_LOCAL_VER"');
// 直接从 settings.cfg 读缓存.只有当第一次安装，缓存完全不存在时才跑一次
$latestversion = $settings['filebrowser_LATEST'] ?? "Unknown";

if ($latestversion == "Unknown") {
    $latestversion = exec($DAEMON_SCRIPT . ' "VERSION"');
}
// 获取 WebUI 进程 PID
$webui_pid = exec('pgrep -f "' . basename($BINARY) . '"');
// 日志初始内容
$log_level = isset($_POST['log_level']) ? $_POST['log_level'] : 'all';

// --- E. 保存配置逻辑 ---
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['save_config_btn'])) {
    $new_content = $_POST['config_text'];
    $daemon_path = "/usr/local/emhttp/plugins/filebrowser_quantum/Daemon.sh";
    if (file_put_contents($CONFIG_YAML, $new_content) !== false) {
        // 依然检测进程，确保用户改完配置后能即时生效
        $is_running = !empty(exec('pgrep -f "' . basename($BINARY) . '"'));
        $is_enabled = ($settings['filebrowser_ENABLED'] == 'true' || $settings['filebrowser_ENABLED'] == '1');
        if ($is_enabled || $is_running) {
            exec("bash $daemon_path 'false' > /dev/null 2>&1");
            sleep(2);
            exec("bash $daemon_path 'true' > /dev/null 2>&1");
            echo "<script>alert('配置已保存并重启服务！'); window.location.href=window.location.href;</script>";
        } else {
            echo "<script>alert('配置已保存！'); window.location.href=window.location.href;</script>";
        }
        exit;
    }
}
// ========================================================

?>

<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* 核心布局 */
.row { display: flex; flex-direction: column; }
.column { padding: 10px; width: 100%; box-sizing: border-box; }

/* 修复按钮：强制文字居中 */
.left input[type="button"], .right input[type="button"] {
    width: 200px !important;
    height: 34px !important;
    line-height: 32px !important; 
    padding: 0 !important;
    margin-bottom: 8px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
    text-align: center;
    cursor: pointer;
    /* 居中核心 */
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* 侧边容器：统一宽度与样式 */
.status-box {
    width: 200px;
    padding: 10px;
    background: #fdfdfd;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 12px;
    box-sizing: border-box;
}

@media screen and (min-width: 1024px) {
    .row { flex-direction: row; flex-wrap: nowrap; }
    .left { flex: 0 0 230px; }
    .mid { flex: 1; border-right: 1px solid #eee; border-left: 1px solid #eee; min-width: 350px; }
    .right { flex: 1; min-width: 350px; position: relative; }
    
    /* 顶部对齐：让三列的标题高度一致 */
    .column h2 { margin-top: 0; margin-bottom: 15px; }
    
    .column.right form { position: absolute; top: 0px; right: 15px; margin: 0; }
    .column.right select { width: 140px !important; }
}

.log-area {
    height: 500px;
    background: #1e1e1e;
    color: #dcdcdc;
    font-family: bitstream, monospace;
    font-size: 12px;
    padding: 10px;
    border-radius: 3px;
    white-space: pre-wrap;
    overflow-y: scroll;
    border: 1px solid #333;
}
</style>

</head>

<body>

<div class="row">

    <div class="column left">
        <h2 style="font-size:1.2rem;">Status :</h2>
        <div class="status-box" style="border-left: 4px solid #51aee5; margin-bottom: 10px;">
            <div style="color: #666; margin-bottom: 4px;">已安装: <b class="current_ver_text" style="color:#1a17d6; margin-left:4px;"><?=trim($currentversion)?></b></div>
            <div style="color: #666;">最新版: <b id="latest_ver_val" style="color:#eb2b2b; margin-left:4px;"><?=trim($latestversion)?></b></div>
        </div>

        <div class="status-box" style="border-left: 4px solid #666; margin-bottom: 10px;">
            <label style="display:block; cursor:pointer; margin-bottom:5px;">
                <input type="radio" name="branch_radio" value="1" <?php if($branch == 1) echo "checked"; ?> onclick="changeBranch(this.value);"> Stable Branch
            </label>
            <label style="display:block; cursor:pointer;">
                <input type="radio" name="branch_radio" value="2" <?php if($branch == 2) echo "checked"; ?> onclick="changeBranch(this.value);"> Beta Branch
            </label>
        </div>

        <input type="button" id="update_btn_id" value="UPDATE" 
            <?php if (trim($currentversion) == trim($latestversion) || $latestversion == "Unknown") echo "disabled"; ?> 
            onclick="updatefilebrowser_quantum('<?php echo $branch; ?>')">

        <hr style="width:200px; margin: 15px 0; border:0; border-top:1px solid #eee;">

        <h2 style="font-size:1.2rem;">Service :</h2>
        <div id="service_status_container" class="status-box" style="border-left: 4px solid <?= !empty($webui_pid) ? '#4caf50' : '#f44336' ?>; margin-bottom: 10px;">
            <div id="service_status_label" style="font-weight: bold; color: <?= !empty($webui_pid) ? '#4caf50' : '#f44336' ?>;">
                <span><?= !empty($webui_pid) ? '● RUNNING' : '○ STOPPED' ?></span>
            </div>
            <div style="color: #999; margin-top:4px;">PORT: <strong style="color:#666;"><?= $dynamic_port ?></strong></div>
        </div>

        <form action="" method="post" style="margin:0;">
            <div class="status-box" style="border-left: 4px solid #666; margin-bottom: 10px;">
                <label style="display:block; cursor:pointer; margin-bottom:5px;">
                    <input type="radio" name="webui_radio" value="true" <?php if($settings['filebrowser_ENABLED'] == 'true') echo "checked"; ?> onclick="toggleService(this.value);"> Enabled
                </label>
                <label style="display:block; cursor:pointer;">
                    <input type="radio" name="webui_radio" value="false" <?php if($settings['filebrowser_ENABLED'] != 'true') echo "checked"; ?> onclick="toggleService(this.value);"> Disabled
                </label>
            </div>
            <input type="hidden" id="webui_status_hidden" name="webui_status" value="<?= ($settings['filebrowser_ENABLED'] == 'true') ? 'true' : 'false' ?>">
            
            <input type="button" name="apply_btn" value="APPLY" disabled onclick="webui(this.form)">
            <? if (!empty($webui_pid)): ?>
            <input type="button" class="localURL" value="OPEN WEBUI" onclick="window.open('http://<?= $_SERVER['SERVER_ADDR'] ?>:<?= $dynamic_port ?>', '_blank')" />
            <? endif; ?>
        </form>
    </div>

    <div class="column mid">
    <h2>Edit config</h2>
    <form id="config_form" method="POST">
      <textarea spellcheck="false" name="config_text" 
        oninput="var btn=document.getElementById('SAVE_btn'); btn.style.background='#4caf50'; btn.style.color='#fff'; btn.style.borderColor='#4caf50';" 
        style="font-family:bitstream, monospace; width:100%; height:500px; padding:10px; box-sizing:border-box;"
      ><?=htmlspecialchars($config_text);?></textarea>

      <br><br> 
      <a id="SAVE_btn" href="javascript:void(0);" 
       onclick="if(confirm('确定要保存配置吗？')){ document.getElementById('config_form').submit(); }"
       style="display: inline-block; 
              padding: 0 25px;            /* 增加左右内边距，让它变宽 */
              height: 32px;               /* 增加高度 */
              line-height: 30px;          /* 让文字垂直居中，比高度小2px即可 */
              background: #f2f2f2; 
              color: #333; 
              border: 1px solid #ccc; 
              cursor: pointer; 
              text-decoration: none; 
              border-radius: 2px; 
              font-family: 'Clear Sans', sans-serif; 
              font-size: 12px;            /* 字体保持你满意的状态 */
              font-weight: bold; 
              text-transform: uppercase; 
              letter-spacing: 2px; 
              box-sizing: border-box; 
              vertical-align: middle;">
       SAVE
    </a>

    <input type="hidden" name="save_config_btn" value="1">
    
    <input type="button" value="Original" onclick="setDefault(this.form)" style="margin-left: 10px; vertical-align: middle;">
  </form> 
    </div>

    <div class="column right">
    <h2>Logging</h2>
    <form class="level-form" onsubmit="return false;">
        <?php $available_levels = getLogLevels($CONFIG_YAML); ?>
        <select name="log_level" onchange="startLogTail();">
            <option value="all" <?=$log_level=='all'?'selected':''?>>LEVEL: ALL</option>
            <?php foreach($available_levels as $level): ?>
                <?php if(empty($level)) continue; ?>
                <option value="<?=$level?>" <?=$log_level==$level?'selected':''?>>
                    LEVEL: <?=strtoupper($level)?>
                </option>
            <?php endforeach; ?>
        </select>
    </form>
    <div class="log-area">正在连接实时日志流...</div>
    
    <div style="margin-top:24px;">
        <input type="button" value="CLEAR LOG" onclick="clearLog();">
    </div>
    </div>
</div>

</body>
</html>

<script>
function setDefault(form) {
  form.elements['config_text'].value = <?=json_encode($default_config_text);?>;
}
// 自动滚动逻辑：仅在页面加载完成后执行一次
$(document).ready(function() {
    var logArea = document.querySelector('.log-area');
    if (logArea) {
        logArea.scrollTop = logArea.scrollHeight;
    }
});
</script>

> Click the **Apply** button to commit the current edits.
>
> Click the **Original** button to initialize the edit box with the
> original contents.  You still need to click **Apply** in order to
> commit the change.
