name: Build rclone Unraid Package (v5)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 关键步骤：在 Ubuntu 上安装 Slackware 打包工具
      - name: Setup Slackware pkgtools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils
          # 下载 Slackware 的 pkgtools (包含 makepkg)
          wget http://mirrors.slackware.com/slackware/slackware64-15.0/slackware64/a/pkgtools-15.0-noarch-3.txz
          # 解压出 makepkg 脚本
          mkdir pkgtools
          tar -C pkgtools -xf pkgtools-15.0-noarch-3.txz
          # 将 makepkg 移动到系统路径并赋予权限
          sudo cp pkgtools/sbin/makepkg /usr/local/bin/
          sudo chmod +x /usr/local/bin/makepkg
          # 验证安装
          makepkg --version || echo "makepkg installed"

      - name: Build Package (v5)
        run: |
          # 进入脚本所在目录
          cd ./source/rclone/
          chmod +x pkg_build.sh
          # 运行构建脚本
          ./pkg_build.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rclone-unraid-pkg
          path: ./source/rclone/*.txz
