name: Run Package Build (v10)

on:
  push:
    branches: [ "test" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 使用 tar 代替复杂的 cpio 模拟脚本，兼容性更好
      - name: Run Build with Professional Structure
        run: |
          mkdir -p archive
          # 定义版本号和包名
          VERSION=$(date +"%Y.%m.%d")
          PKG_NAME="filebrowser_quantum-${VERSION}-x86_64.txz"
          
          # 进入包含 usr 文件夹的目录
          cd source/filebrowser_quantum
          
          # 核心修改：使用 tar 打包
          # Unraid 的 .txz 本质上就是用 xz 压缩的 tar 包
          # -c: 创建, -J: 使用 xz 压缩, -f: 指定文件名
          tar -cvJf ../../archive/$PKG_NAME .
          
          # 生成 MD5
          cd ../..
          md5sum archive/$PKG_NAME > archive/$PKG_NAME.md5
          echo "Build Success: archive/$PKG_NAME"

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add archive/*.txz archive/*.md5
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "auto: v10 use tar for professional structure"
            git push
          fi
