name: Build filebrowser_quantum Unraid Package (v6)

on:
  push:
    branches: [ master, main, test ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Slackware pkgtools (makepkg)
        run: |
          # 下载 Slackware 的工具包 (包含 makepkg)
          wget http://mirrors.slackware.com/slackware/slackware64-15.0/slackware64/a/pkgtools-15.0-noarch-3.txz
          # 解压并提取 makepkg
          mkdir pkgtools
          tar -C pkgtools -xf pkgtools-15.0-noarch-3.txz
          sudo cp pkgtools/sbin/makepkg /usr/local/bin/
          sudo chmod +x /usr/local/bin/makepkg
          # 验证安装
          makepkg --version

      - name: Run Build Script (v6)
        run: |
          # 1. 确保构建所需的目录存在
          mkdir -p archive
          
          # 2. 进入脚本所在目录
          cd source/
          chmod +x pkg_build.sh
          
          # 3. 执行脚本
          # 根据你的图片代码，脚本会查找当前目录下除了它自身和 sftp-config.json 以外的文件并打包
          ./pkg_build.sh

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Unraid-Package-v6
          path: archive/*.txz
